---
title: "Project title"
author: "by Team-Name: User1, User2, User3, User4 & User5"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib, include = FALSE}
library(tidyverse)
library(tidyr)
library(leaflet)
library(patchwork)
library(tidymodels)
```


```{r load-data, include=FALSE}
#Loading data

data <- read.csv("data/crime/communitiesUnnormalized.txt", header = FALSE, na.string = "?")
  
names_lines <- read_lines("data/crime/names.names")
  
  
attribute_lines <- grep("^@attribute", names_lines, value = TRUE)
attribute_lines <- gsub("@attribute ", "", attribute_lines)
attribute_lines <- gsub(" .*", "", attribute_lines)

colnames(data) <- c(attribute_lines)

column_names <- colnames(data)

state_names <- data.frame(

  State = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"),

  state_name = c("ALABAMA", "ALASKA", "ARIZONA", "ARKANSAS", "CALIFORNIA", "COLORADO", "CONNECTICUT", "DELAWARE", "DISTRICT OF COLUMBIA", "FLORIDA", "GEORGIA", "HAWAII", "IDAHO", "ILLINOIS", "INDIANA", "IOWA", "KANSAS", "KENTUCKY", "LOUISIANA", "MAINE", "MARYLAND", "MASSACHUSETTS", "MICHIGAN", "MINNESOTA", "MISSISSIPPI", "MISSOURI", "MONTANA", "NEBRASKA", "NEVADA", "NEW HAMPSHIRE", "NEW JERSEY", "NEW MEXICO", "NEW YORK", "NORTH CAROLINA", "NORTH DAKOTA", "OHIO", "OKLAHOMA", "OREGON", "PENNSYLVANIA", "RHODE ISLAND", "SOUTH CAROLINA", "SOUTH DAKOTA", "TENNESSEE", "TEXAS", "UTAH", "VERMONT", "VIRGINIA", "WASHINGTON", "WEST VIRGINIA", "WISCONSIN", "WYOMING"),

  latitude = c(32.806671, 61.370716, 33.729759, 34.969704, 36.116203, 39.059811, 41.597782, 39.318523, 38.897438, 27.766279, 33.040619, 21.094318, 44.240459, 40.349457, 39.849426, 42.011539, 38.5266, 37.66814, 31.169546, 44.693947, 39.063946, 42.230171, 43.326618, 45.694454, 32.741646, 38.456085, 46.921925, 41.12537, 38.313515, 43.452492, 40.298904, 34.840515, 42.165726, 35.630066, 47.528912, 40.388783, 35.565342, 44.572021, 40.590752, 41.680893, 33.856892, 44.299782, 35.747845, 31.054487, 39.32098, 44.045876, 37.769337, 47.400902, 38.491226, 44.268543, 42.755966),

  longitude = c(-86.79113, -152.404419, -111.431221, -92.373123, -119.681564, -105.311104, -72.755371, -75.507141, -77.026817, -81.686783, -83.643074, -157.498337, -114.478828, -88.986137, -86.258278, -93.210526, -96.726486, -84.670067, -91.867805, -69.381927, -76.802101, -71.530106, -84.536095, -93.900192, -89.678696, -92.288368, -110.454353, -98.268082, -117.055374, -71.563896, -74.521011, -106.248482, -74.948051, -79.806419, -99.784012, -82.764915, -96.928917, -122.070938, -77.209755, -71.51178, -80.945007, -99.438828, -86.692345, -97.563461, -111.950684, -72.710686, -78.169968, -121.490494, -80.954456, -89.616508, -107.30249)

)

# Join State information with data

data <- data %>%

  left_join(state_names, by = "State")
```


## Research Question

Which factors influence more on the crime level of a city in the United States? (Clearly we should refine this statement)





## Data

Briefly describe your dataset here - include a description of the key variables you will be investigating. 
Include a citation for your data. 
See http://libraryguides.vu.edu.au/c.php?g=386501&p=4347840 for guidance on proper citation for datasets. 
If you got your data off the web, make sure to state the retrieval date.






## Findings

## Economic variables

In order to find a suitable economic variable to model the violence in a given city, we'll start by taking a look at the income per capita.

Let's equally split the variable perCapInc into four categories representing the level of wealth of each city, and let's visualize the relation of these categories with the ViolentPerPop:

```{r, echo = TRUE, warning = FALSE}
data <- data %>%
  mutate(
    wealth_category = cut(
      perCapInc,
      breaks = quantile(perCapInc, probs = seq(0, 1, 0.25), na.rm = TRUE),
      include.lowest = TRUE,
      labels = c("Low wealth", "Middle-Low wealth", "Middle-High Wealth", "High Wealth")
    )
  )

ggplot(data, aes(x = wealth_category, y = violentPerPop, fill = wealth_category)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Violent Crimes per each wealth category",
    x = "Wealth category",
    y = "Violent crimes per 100K"
  ) +
  theme_minimal()
```

We spot a clear relation between the economic level of a city and the level of violent, that is, as the level of wealth increases, the level of violent decreases.

However, recall that the income per capita is mathematically defined as follows:
$$
perCapInc = \frac{\text{Total Income}}{Population}
$$
That means, if the total income is **large enough**, the perCapInc variable will grow independently of how equally distributed are the resources within the population. This encourages us to include some other variable that better measures this distribution.

Let's take a look at the pctPoverty variable (percentage of people under poverty). It is well-known that as the population under poverty increases in a country, then does the level of crime as well.

Nevertheless, something interesting happens when we observe the relation between the poverty and crime for each of the wealth categories:

```{r, echo = TRUE, warning=FALSE}
ggplot(data, aes(x = pctPoverty, y = violentPerPop)) +
  geom_point(alpha = 0.6, color = "blue") +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  facet_wrap(~ wealth_category, scales = "free") +
  labs(
    title = "Crimes vs Percentage of People Under Poverty",
    x = "Percentage Under Poverty",
    y = "Violent Crimes per 100K"
  ) +
  theme_minimal()

data %>%
  group_by(wealth_category) %>%
  summarise(
  coef = cor(pctPoverty, violentPerPop, use = "complete.obs", method = "pearson"))

```

The plots above show that there's a stronger linear relationship between the percentage of people under poverty and the crime level as the wealth quality increases.

An easy way to interpret these plots is by taking two different populations with the same percentage of poverty each one, and then, the population with **more** income per capita is likely to have a **higher** crime level, as there is a more unequal distribution of economic resources, and therefore, a higher perception of injustice by minorities. We summarize it in the following statement:

"The crime level of a population is mostly influenced by the level of economic inequality, rather than the actual percentage of poverty".

```{r, echo=TRUE, warning = FALSE}

family_statistics <- data %>%
  select(medFamIncome, pct2Par, `pctWorkMom-6`, violentPerPop) %>%
  drop_na() %>% # Dropping all NAs
  rename(
    Median_Family_Income = medFamIncome,
    Families_with_two_parents = pct2Par,
    Working_moms = `pctWorkMom-6`
  ) %>% # Renaming variables
  mutate(
    Median_Family_Income_Levels = cut(
      Median_Family_Income,
      breaks = quantile(Median_Family_Income, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE
    ),
    Number_of_Two_Parent_Families = cut(
      Families_with_two_parents,
      breaks = quantile(Families_with_two_parents, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE
    ),
    Number_of_Working_Moms = cut(
      Working_moms,
      breaks = quantile(Working_moms, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE
      )
) # Mutating to create three levels (Low, Medium, High) for income, percentage of two parent families an working moms
```

```{r, echo=TRUE, warning=FALSE}
# Calculating simple summary statistics
family_statistics_summary <- family_statistics %>%
  summarise(across(where(is.numeric),
      list(
        mean = ~mean(.x, na.rm = TRUE),
        median = ~median(.x, na.rm = TRUE),
        sd = ~sd(.x, na.rm = TRUE),
        min = ~min(.x, na.rm = TRUE),
        max = ~max(.x, na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"))
family_statistics_summary
```

```{r, echo=TRUE, warning=FALSE}
# Combining Levels (Low, Medium, High) and Category (Income_Levels, Two_Parent_Families, Working_Moms)
family_statistics_long <- family_statistics %>%
  pivot_longer(
    cols = c(Median_Family_Income_Levels, Number_of_Two_Parent_Families, Number_of_Working_Moms),
    names_to = "Category",
    values_to = "Level"
  ) 

# Defining Level
family_statistics_long <- family_statistics_long %>%
  mutate(
    Level = factor(Level, levels = c("Low", "Medium", "High"))
  )

# Deleting underscore from variable names
family_statistics_long <- family_statistics_long %>%
  mutate(
    Category = str_replace_all(Category, "_", " ")
)
```

```{r, echo=TRUE, warning=FALSE}
# Box plot showing the relationship between familial status and violent crimes
ggplot(family_statistics_long, 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  facet_wrap(~ Category, scales = "free") +
  labs(
    title = "Boxplot of Violent Crimes Per Population by Socioeconomic Levels of Families",
    subtitle = "Grouped by Median Family Income, Number of Two Parent Families and Number of Working moms",
    x = "Socioeconomic Levels",
    y = "Number of violent Crimes Per Population"
  ) +
  theme_minimal() +
  theme_bw() +
  theme(
    plot.subtitle = element_text(size = 10),
    strip.text = element_text(size = 7)
  )
```
```{r, echo=TRUE, warning=FALSE}
 # Histogram showing the relationship between family status and violent crimes
ggplot(data = family_statistics_long, 
       mapping = aes(
         x = violentPerPop,
         fill = Level
         )) +
  geom_histogram(
    bins = 50,
    alpha = 1 
    ) +
  labs(
    x = "Number of Crimes",
     y = "Frequency",
     title = "Histogram of Socioeconomic Level and Violent Crimes Per Population",
    subtitle = "Grouped by Median Family Income, Number of Two Parent Families and Number of Working moms"
  ) +
  facet_wrap(~ Category,
             ncol = 3) +
  theme(
    plot.subtitle = element_text(size = 10) 
  )

```

```{r, echo=TRUE, warning=FALSE}

two_parents_vs_crime <- ggplot(family_statistics_long, aes(
  x = Families_with_two_parents,
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "forestgreen") +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  labs(
    title = "Crimes per Population and Number of Families with Two Parents",
    x = "Number of Families with Two Parents",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
   theme(
    plot.title = element_text(size = 8),
    axis.title.x = element_text(size = 7),
    axis.title.y = element_text(size = 7)
  )

income_vs_crime <- ggplot(family_statistics_long, aes(
  x = Median_Family_Income,
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "red") +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  labs(
    title = "Crimes per Population and Median Family Income",
    x = "Median Family Income",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 8),
    axis.title.x = element_text(size = 7),
    axis.title.y = element_text(size = 7)
  )

moms_vs_crime <- ggplot(family_statistics_long, aes(
  x = Working_moms, 
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "yellow") +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  labs(
    title = "Crimes per Population and Number of Families With Working Moms",
    x = "Number of Families With Working Moms",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 8),
    axis.title.x = element_text(size = 7),
    axis.title.y = element_text(size = 7)
  )

combined_plot <- two_parents_vs_crime + income_vs_crime + moms_vs_crime + plot_layout(ncol = 2)
print(combined_plot)
```

```{r}

# Geospatial data available at the geojson format
tmp_geojson <- "/Users/dimitrisagouridis/GroupProject/data/continental-us-states.json"

# Load necessary packages
library(sf)
library(ggplot2)
library(dplyr)

# Verify if the uploaded GeoJSON file exists
if (!file.exists(tmp_geojson)) {
  stop("The GeoJSON file could not be found. Please check the file path.")
}

# Read the GeoJSON file with error handling
my_sf <- tryCatch(
  {
    read_sf(tmp_geojson)
  },
  error = function(e) {
    stop("Error reading the GeoJSON file. Please check if the file is corrupt, in an unsupported format, or if there are permissions issues: ", e$message)
  }
)

# Proceed with the rest of your code as before
# Ensure state names in my_sf are uppercase to match the violentPerPop dataset
my_sf$name <- toupper(my_sf$name)

# Remove Alaska and Hawaii from the violentPerPop dataset
violentPerPop <- violentPerPop %>%
  filter(!(state_name %in% c("ALASKA", "HAWAII")))

# Join the GeoJSON spatial data with the violentPerPop dataset
choropleth_data <- my_sf %>%
  left_join(violentPerPop, by = c("name" = "state_name"))

# Create a choropleth map using ggplot2 with a customized style
p <- ggplot(choropleth_data) +
  geom_sf(aes(fill = value), linewidth = 0, alpha = 0.9) +
  theme_void() +
  scale_fill_gradient(
    low = "lightcoral", high = "darkred",
    na.value = "grey50",
    name = "Amount of Violent Crimes per 100k",
    guide = guide_legend(
      keyheight = unit(3, units = "mm"),
      keywidth = unit(12, units = "mm"),
      label.position = "bottom",
      title.position = "top",
      nrow = 1
    )
  ) +
  labs(
    title = "Choropleth Map of Violence Rates by State",
    subtitle = "Violence rates per state based on provided data",
    caption = "Data: violentPerPop"
  ) +
  theme(
    text = element_text(color = "#22211d"),
    plot.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.background = element_rect(fill = "#f5f5f2", color = NA),
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    plot.title = element_text(
      size = 13, hjust = 0.01, color = "#4e4d47",
      margin = margin(
        b = -0.1, t = 0.4, l = 2,
        unit = "cm"
      )
    ),
    plot.subtitle = element_text(
      size = 10, hjust = 0.01,
      color = "#4e4d47",
      margin = margin(
        b = -0.1, t = 0.43, l = 2,
        unit = "cm"
      )
    ),
    plot.caption = element_text(
      size = 8,
      color = "#4e4d47",
      margin = margin(
        b = 0.3, r = -99, t = 0.3,
        unit = "cm"
      )
    ),
    legend.position = c(0.7, 0.09)
  )

p


```


```{r echo = TRUE, warning = FALSE}

set.seed(1234)
datasplit <- initial_split(data)
data_train <- training(datasplit)
data_test  <- testing(datasplit)

# During the meeting, the idea is to change the variables after "~" in the following line, and decide the best model to use.

data_mod <- linear_reg() %>%
  set_engine("lm")

data_rec <- recipe(violentPerPop ~ pctPoverty, data = data_train)

data_wflow <- workflow() %>%
  add_model(data_mod) %>%
  add_recipe(data_rec)

data_fit <- data_wflow %>%
  fit(data = data_train)

data_train_pred <- data_fit %>%
  predict(data_train) %>%
  bind_cols(data_train %>% select(violentPerPop,communityname))

data_train_pred

rsq(data_train_pred, truth = violentPerPop, estimate = .pred)
```

## References

List any references here. You should, at a minimum, list your data source.

0
