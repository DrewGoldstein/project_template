---
title: "Building A Model to Determine the Relationship Between Socio-Economic Factors and Crime"
subtitle: ""
author: "Crime Crunchers <br> Drew Goldstein, Manuel Cabrera, Dimitris Bardanis, Dimitris Agouridis, Shane Chesen, Samuel Prior"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

```{r install-package, include = FALSE, eval = FALSE}
# Copy and paste the following code into your console to download and install
# the `xaringan` package that contains all of the code which allows you 
# to create presentation slides in Rmarkdown
install.packages('xaringan')
```


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(xaringanExtra)
xaringanExtra::use_panelset()
library(patchwork)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
# Load your data here
data <- read.csv("data/crime/communitiesUnnormalized.txt", header = FALSE, na.string = "?")
  
names_lines <- read_lines("data/crime/names.names")
  
  
attribute_lines <- grep("^@attribute", names_lines, value = TRUE)
attribute_lines <- gsub("@attribute ", "", attribute_lines)
attribute_lines <- gsub(" .*", "", attribute_lines)

colnames(data) <- c(attribute_lines)

column_names <- colnames(data)

state_names <- data.frame(

  State = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"),

  state_name = c("ALABAMA", "ALASKA", "ARIZONA", "ARKANSAS", "CALIFORNIA", "COLORADO", "CONNECTICUT", "DELAWARE", "DISTRICT OF COLUMBIA", "FLORIDA", "GEORGIA", "HAWAII", "IDAHO", "ILLINOIS", "INDIANA", "IOWA", "KANSAS", "KENTUCKY", "LOUISIANA", "MAINE", "MARYLAND", "MASSACHUSETTS", "MICHIGAN", "MINNESOTA", "MISSISSIPPI", "MISSOURI", "MONTANA", "NEBRASKA", "NEVADA", "NEW HAMPSHIRE", "NEW JERSEY", "NEW MEXICO", "NEW YORK", "NORTH CAROLINA", "NORTH DAKOTA", "OHIO", "OKLAHOMA", "OREGON", "PENNSYLVANIA", "RHODE ISLAND", "SOUTH CAROLINA", "SOUTH DAKOTA", "TENNESSEE", "TEXAS", "UTAH", "VERMONT", "VIRGINIA", "WASHINGTON", "WEST VIRGINIA", "WISCONSIN", "WYOMING"),

  latitude = c(32.806671, 61.370716, 33.729759, 34.969704, 36.116203, 39.059811, 41.597782, 39.318523, 38.897438, 27.766279, 33.040619, 21.094318, 44.240459, 40.349457, 39.849426, 42.011539, 38.5266, 37.66814, 31.169546, 44.693947, 39.063946, 42.230171, 43.326618, 45.694454, 32.741646, 38.456085, 46.921925, 41.12537, 38.313515, 43.452492, 40.298904, 34.840515, 42.165726, 35.630066, 47.528912, 40.388783, 35.565342, 44.572021, 40.590752, 41.680893, 33.856892, 44.299782, 35.747845, 31.054487, 39.32098, 44.045876, 37.769337, 47.400902, 38.491226, 44.268543, 42.755966),

  longitude = c(-86.79113, -152.404419, -111.431221, -92.373123, -119.681564, -105.311104, -72.755371, -75.507141, -77.026817, -81.686783, -83.643074, -157.498337, -114.478828, -88.986137, -86.258278, -93.210526, -96.726486, -84.670067, -91.867805, -69.381927, -76.802101, -71.530106, -84.536095, -93.900192, -89.678696, -92.288368, -110.454353, -98.268082, -117.055374, -71.563896, -74.521011, -106.248482, -74.948051, -79.806419, -99.784012, -82.764915, -96.928917, -122.070938, -77.209755, -71.51178, -80.945007, -99.438828, -86.692345, -97.563461, -111.950684, -72.710686, -78.169968, -121.490494, -80.954456, -89.616508, -107.30249)

)

# Join State information with data

data <- data %>%

  left_join(state_names, by = "State")
```

### What is The Data?

- The data was obtained from US government agencies who retrieved the data through internal surveys. The data contains information on location, socio-economic factors, crime data as well as police department data. 

- The data is designed around the goal variable, ViolentCrimesPerPopulation. This is the response variable which will be predicted. There are 122 predictive variables all of which are decimal numerical values between 0 and 1. As well as non predictive string and numerical variables describing location and county/community code. 

- The data was taken from a data set with numerical values and normalised between 0 and 1. The dataset was available online, the dataset was imported and a new dataframe was created.

### What kind of question can this answer?

Questions regarding crime in the community with regards to:
- Economic Factors 
- Education
- Social Factors
- Police 

---

### What is the Question?

Which factors influence the crime level of a community in the United States?

Using these factors can a suitable model be defined?

--

The indicators in the categories are all similar so it would only be useful to investigate one of these as they are highly correlated with each other. We shall try and determine which has the greatest correlation by way of line of best fit

---

# Importing Data

The dataset was imported from as a .txt file however had a format of a .data file. The column names were stored in a seperate .names file which had information pertaining to the dataset and variables as well as sources and methods. The columns were read from the text file and stored in a df with the column names being read in and stored as the column names. At this point the state was stored as a numerical value and so we got the relevant state codes from .. and replaced the numbers with codes.
The unnormalized version of the data was found online and then joined to our dataset. 

---

# Cleaning

- Remove NAs 
- Replacing normalised data
- Dropping unnecesary variables

---

# Pre Processing

- The perCapInc variable is split into four categories representing the level of wealth of each city.
- Family statistics were calculated and summarised. 
- State initials replaced state codes 
- Geospatial data added for states

---

### Variables of Interest

Economic:

- pctPoverty: percentage of people under poverty

- perCapInc: income per capita

Social

- medFamIncome: median income of families

- pct2Par: percentage of families with two parents

- pctWorkMom-6: percentage of moms of kids 6 and under in labor force

Demographic

- popDensity: population density

- policePerPop: police officers per 100K population

---

# Description of Techniques Used

Scatter plots were used to determine a relationship between variables and violent crimes per population, this was important as it allowed us to determine which variables were correlated and should be used in our model. 

histograms 

maps

box plots

residuals plots

roc curves

---
# Exploratory Data Analysis

violent crimes per wealth category

crimes vs percentages of people under poverty 

gradient coefficients

boxplot of violent crimes

---
class: center, middle

# Section 2: Crimes and Family

---
# Looking at three variables related to family
.pull-left-wide[ 
- ### **`medFamIncome`**: Median Family Income  
- ### **`pct2Par`**: Percentage of families with two parents  
- ### **`pctWorkMom-6`**: Percentage of families with working mothers
]

### We investigated the impact of the above on the  `violentPerPop` variable

---
# Simple Mutation
.pull-left[
- Renaming variables for readability

- Dividing **`Median Family Income`** into five categories (Very Low, Low, Medium, High, Very High) and **`Number_of_Working_Moms`**, **`Number_of_Two_Parent_Families`** into three categories (Low, Medium, High)

- **`Median Family Income`** is divided into 5 (0 to 0.1, 0.1 to 0.5, 0.5 to 0.9, 0.9 to 0.99 and 0.99 to 1) instead of terciles, to reflect the skewed nature of income levels. 
]
.pull-right[
<style>
  .code-block {
    position: relative;
    top: -100px; 
  }
</style>

<div class="code-block">
```{r code-block, echo=TRUE, eval=FALSE}
mutate(
    Median_Income = cut(
      Median_Family_Income,
      breaks = quantile(Median_Family_Income, probs = c(0, 0.1, 0.5, 0.9, 0.99, 1), na.rm = TRUE),
      labels = c( "Very Low", "Low", "Medium", "High", "Very High"),
      include.lowest = TRUE
    ),
    Two_Parent_Families = cut(
      Families_with_two_parents,
      breaks = quantile(Families_with_two_parents, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE
    ),
    Working_Moms = cut(
      Working_moms,
      breaks = quantile(Working_moms, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE
      )
)
```

]

---

## Box Plot: Familial Situation vs Violent Crimes per 100K

```{r  family_mutation2, echo=FALSE}
family_statistics <- data %>%
  select(medFamIncome, pct2Par, `pctWorkMom-6`, violentPerPop) %>%
  drop_na() %>% # Dropping all NAs
  rename(
    Median_Family_Income = medFamIncome,
    Families_with_two_parents = pct2Par,
    Working_moms = `pctWorkMom-6`
  ) %>% # Renaming variables
  mutate(
    Median_Income = cut(
      Median_Family_Income,
      breaks = quantile(Median_Family_Income, probs = c(0, 0.1, 0.5, 0.9, 0.99, 1), na.rm = TRUE),
      labels = c( "Very Low", "Low", "Medium", "High", "Very High"),
      include.lowest = TRUE),
    Two_Parent_Families = cut(
      Families_with_two_parents,
      breaks = quantile(Families_with_two_parents, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE),
    Working_Moms = cut(
      Working_moms,
      breaks = quantile(Working_moms, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE)
)
family_statistics_long <- family_statistics %>%
  pivot_longer(
    cols = c(Median_Income, Two_Parent_Families, Working_Moms),
    names_to = "Category",
    values_to = "Level"
  ) 
family_statistics_long <- family_statistics_long %>%
  mutate(
    Level = factor(Level, levels = c("Very Low", "Low", "Medium", "High", "Very High"))
  )
family_statistics_long <- family_statistics_long %>%
  mutate(
    Category = str_replace_all(Category, "_", " "))
```
.panelset[

.panel[.panel-name[Income]

.pull-left[
```{r  family_boxplot1, echo=FALSE, out.width="1000"}
ggplot(family_statistics_long %>% filter(Category == "Median Income"), 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  labs(
    title = "Crimes per Population vs Median Family Income",
    x = "Median Income Levels",
    y = "Number of Violent Crimes per Population"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10)
  )
```
]]

.panel[.panel-name[Parents]

.pull-left[
```{r  family_boxplot2, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long %>% filter(Category == "Two Parent Families"), 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  labs(
    title = "Crimes per Population vs Number of Two Parent Families",
    x = "Number of Two Parent Families",
    y = "Number of Violent Crimes per Population"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10)
  )
```
] ]

.panel[.panel-name[Moms]

.pull-left[
```{r  family_boxplot3, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long %>% filter(Category == "Working Moms"), 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  labs(
    title = "Crimes per Population vs Number of Working Moms",
    x = "Number of Working Moms",
    y = "Number of Violent Crimes per Population"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10)
  )
```
] ] ]

.pull-right[
- Analysis
]

---
## Familial Situation vs Violent Crimes Per 100K Box Plot
```{r  family_boxplot_full, echo=FALSE, out.width="80%", out.extra='style="display: block; margin: 0 auto;"'}
ggplot(family_statistics_long, 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  facet_wrap(~ Category, scales = "free", ncol = 3) +
  labs(
    x = "Socioeconomic Levels",
    y = "Number of violent Crimes Per Population"
  ) +
  theme_minimal() +
  theme_bw() +
  theme(
    plot.subtitle = element_text(size = 10),
    strip.text = element_text(size = 7),
    axis.text.x = element_text(size = 7, angle = 45, hjust = 1)
  )
```


---

## Scatter Plot: Familial Situation vs Violent Crimes per 100K

.panelset[

.panel[.panel-name[Parents]

.pull-left[
```{r two_parents_scatter, message=FALSE, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long, aes(
  x = Families_with_two_parents,
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "forestgreen") +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  labs(
    title = "Crimes per Population and Number of Families with Two Parents",
    x = "Number of Families with Two Parents",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9)
  )
```
] ]

.panel[.panel-name[Income] .pull-left[
```{r income_scatter, message=FALSE, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long, aes(
  x = Median_Family_Income,
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "red") +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  labs(
    title = "Crimes per Population and Median Family Income",
    x = "Median Family Income",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9)
  )
```
] ]

.panel[.panel-name[Moms] .pull-left[
```{r moms_scatter, message=FALSE, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long, aes(
  x = Working_moms, 
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "yellow") +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  labs(
    title = "Crimes per Population and Number of Families With Working Moms",
    x = "Number of Families With Working Moms",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9)
  )
```
] ] ]

.pull-right[
- Analysis
]

---
# Key Findings From Crimes and Family
- What did we find out?
- What are the implications of the results?

---

# Model

- The model used was a linear model 

---

# Results

---

![My Plot](img/scatter.png)

residuals plot 

roc curve

maps

---

# Results in Context

---

# Discussion

---

# Conclusion

