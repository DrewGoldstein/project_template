---
title: "Crimes and Communities in the US"
subtitle: ""
author: "Crime Crunchers <br> Drew Goldstein, Manuel Cabrera, Dimitris Bardanis, Dimitris Agouridis, Shane Chesen, Samuel Prior"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

```{r install-package, include = FALSE, eval = FALSE}
# Copy and paste the following code into your console to download and install
# the `xaringan` package that contains all of the code which allows you 
# to create presentation slides in Rmarkdown
install.packages('xaringan')
```


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(xaringanExtra)
xaringanExtra::use_panelset()
library(patchwork)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
#Loading data

data <- read.csv("data/crime/communitiesUnnormalized.txt", header = FALSE, na.string = "?")
  
col_names <- read_lines("data/crime/names.names")
col_names <- grep("@attribute", col_names, value = TRUE)
col_names <- gsub("@attribute ", "", col_names)
col_names <- gsub(" .*", "", col_names)

colnames(data) <- c(col_names)

state_names <- data.frame(
  State = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"),

  state_name = c("ALABAMA", "ALASKA", "ARIZONA", "ARKANSAS", "CALIFORNIA", "COLORADO", "CONNECTICUT", "DELAWARE", "DISTRICT OF COLUMBIA", "FLORIDA", "GEORGIA", "HAWAII", "IDAHO", "ILLINOIS", "INDIANA", "IOWA", "KANSAS", "KENTUCKY", "LOUISIANA", "MAINE", "MARYLAND", "MASSACHUSETTS", "MICHIGAN", "MINNESOTA", "MISSISSIPPI", "MISSOURI", "MONTANA", "NEBRASKA", "NEVADA", "NEW HAMPSHIRE", "NEW JERSEY", "NEW MEXICO", "NEW YORK", "NORTH CAROLINA", "NORTH DAKOTA", "OHIO", "OKLAHOMA", "OREGON", "PENNSYLVANIA", "RHODE ISLAND", "SOUTH CAROLINA", "SOUTH DAKOTA", "TENNESSEE", "TEXAS", "UTAH", "VERMONT", "VIRGINIA", "WASHINGTON", "WEST VIRGINIA", "WISCONSIN", "WYOMING")
)

# Join State information with data

data <- data %>%
  left_join(state_names, by = "State")

# Getting rid of NA's in the variables of our interest

data <- data %>%
  filter(!is.na(violentPerPop) & violentPerPop != 0)
```

class: center, middle

## What economic, social, and demographic factors most significantly influence the crime rates in cities across the United States?

---

# What is The Data?

.panelset[

.panel[.panel-name[Description]

The dataset we'll be using contains:

- **Socio-economic data** from the '90 Census
- **Law enforcement data** from the 1990 Law Enforcement Management and Admin Stats survey
- **Crime data** from the 1995 FBI UCR

*Source*

Redmond, M. (2009). Communities and Crime Unnormalized [Dataset]. UCI Machine Learning Repository. https://doi.org/10.24432/C5PC8X.

]

.panel[.panel-name[Preview]

```{r showing_data, echo = FALSE}
data %>%
  select(communityname, pctPoverty, perCapInc, pct2Par, violentPerPop) %>%
  head(18)

```

]]

---

## Variables we'll be working with

### **Economic:**
- `pctPoverty`: percentage of people under poverty
- `perCapInc`: income per capita

### **Social:**
- `medFamIncome`: median income of families
- `pct2Par`: percentage of families with two parents
- `pctWorkMom-6`: percentage of moms of kids 6 and under in labor force

### **Demographic:**
- `popDensity`: population density
- `policePerPop`: police officers per 100K population

---

# Data cleaning and Wrangling

- Assigned the column's names in the file `names.names` to the dataset `communitiesUnnormalized.txt`, and called this dataset `data`.

--

- Created a data frame `state_names` containing: a column `State` with the abbreviated name of states and a column `state_name` containing a string with the complete name.

--

- Left join `data` with `state_names`, by "State".

--

- Filtered all rows in which `violentPerPop` = NA.

---

class: inverse, center, middle

# Section 1: Crimes and Economics

---

# Per Capita Income

.panelset[

.panel[.panel-name[Plots]

.pull-left[
```{r warning=FALSE, out.width="100%", fig.width=4, echo=FALSE}
data <- data %>%
  mutate(
    wealth_group = factor(
      cut(
        perCapInc,
        breaks = quantile(perCapInc, probs = seq(0, 1, 0.25), na.rm = TRUE),
        include.lowest = TRUE,
        labels = c("First Wealth Group", "Second Wealth Group", "Third Wealth Group", "Fourth Wealth Group")
      ),
      levels = c("First Wealth Group", "Second Wealth Group", "Third Wealth Group", "Fourth Wealth Group")
    )
  )

ggplot(data, aes(x = wealth_group, y = violentPerPop, fill = wealth_group)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Violent Crimes per Each Wealth Group",
    x = "Wealth Group",
    y = "Violent crimes per 100K",
    fill = "Wealth Group"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_blank())

```
]
.pull-right[

- In order to find a suitable variable to predict crimes, let's look at the variable `perCapInc`.

- We'll create a categorical variable called wealth_group to divide the perCapInc variable into quartiles.

]

]

.panel[.panel-name[Code]

```r

data <- data %>%
  mutate(
    wealth_group = factor(
      cut(
        perCapInc,
        breaks = quantile(perCapInc, probs = seq(0, 1, 0.25), na.rm = TRUE),
        include.lowest = TRUE,
        labels = c("First Wealth Group", "Second Wealth Group", "Third Wealth Group", "Fourth Wealth Group")
      ),
      levels = c("First Wealth Group", "Second Wealth Group", "Third Wealth Group", "Fourth Wealth Group")
    )
  )

```
]]

---

# Per Capita Income

- Before our next analysis, recall that the income per capita is mathematically defined as follows:

$$
perCapInc = \frac{\text{Total Income}}{\text{Population}}
$$
- That is, if the total income within a given area is **large enough**, the perCapInc variable will grow independently of how equally distributed are the resources within the population.

--

- This suggests that there may be  another variable that, when we take it into account, it better measures this distribution of resources.

- In fact, something interesting happens when considering `pctPoverty`...



---

# Percentage Under Poverty

```{r warning=FALSE, message = FALSE, echo=FALSE}
ggplot(data, aes(x = pctPoverty, y = violentPerPop)) +
  geom_point(alpha = 0.6, color = "blue") +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  facet_wrap(~ wealth_group, scales = "free") +
  labs(
    title = "Crimes vs Percentage of People Under Poverty",
    x = "Percentage Under Poverty",
    y = "Violent Crimes per 100K"
  ) +
  theme_minimal()
  
```

---

# Key observations

- As the wealth category increases, there's a *stronger linear relation* between the percentage of poverty of a city and the crimes per 100K.

- If two cities have the same percentage of poverty, the one with more income per capita has more inequality as well. Therefore, we conclude:

--

<div style="padding: 20px; background-color: #f7dc6f; border-radius: 5px; font-size: 1.5em; color: #333;">

"The crime level of a population is mostly influenced by the level of economic inequality, rather than the income per capita or the actual percentage of poverty"

</div>

---

# Pearson's correlation coefficient

- We can formally support our last findings in a more mathematical way, by calculating the Pearson's correlation coefficient, and observe how they increase.

```{r, message = FALSE, echo = FALSE, out.width="100%"}
data %>%
  group_by(wealth_group) %>%
  summarise(
    coef = cor(pctPoverty, violentPerPop, use = "complete.obs", method = "pearson")
  ) %>%
  kable()
```

---

class: inverse, center, middle

# Section 2: Crimes and Family

---
# Looking at three variables related to family
.pull-left-wide[ 
- ### **`medFamIncome`**: Median Family Income  
- ### **`pct2Par`**: Percentage of families with two parents  
- ### **`pctWorkMom-6`**: Percentage of families with working mothers
]

### We investigated the impact of the above on the  `violentPerPop` variable

---
# Simple Mutation
.pull-left[
- Renaming variables for readability

- Dividing **`Median Family Income`** into five categories (Very Low, Low, Medium, High, Very High) and **`Number_of_Working_Moms`**, **`Number_of_Two_Parent_Families`** into three categories (Low, Medium, High)

- **`Median Family Income`** is divided into 5 (0 to 0.1, 0.1 to 0.5, 0.5 to 0.9, 0.9 to 0.99 and 0.99 to 1) instead of terciles, to reflect the skewed nature of income levels. 
]
.pull-right[
<style>
  .code-block {
    position: relative;
    top: -100px; 
  }
</style>

<div class="code-block">
```{r code-block, echo=TRUE, eval=FALSE}
mutate(
    Median_Income = cut(
      Median_Family_Income,
      breaks = quantile(Median_Family_Income, probs = c(0, 0.1, 0.5, 0.9, 0.99, 1), na.rm = TRUE),
      labels = c( "Very Low", "Low", "Medium", "High", "Very High"),
      include.lowest = TRUE
    ),
    Two_Parent_Families = cut(
      Families_with_two_parents,
      breaks = quantile(Families_with_two_parents, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE
    ),
    Working_Moms = cut(
      Working_moms,
      breaks = quantile(Working_moms, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE
      )
)
```

]

---

## Box Plot: Familial Situation vs Violent Crimes per 100K

```{r  family_mutation2, echo=FALSE}
family_statistics <- data %>%
  select(medFamIncome, pct2Par, `pctWorkMom-6`, violentPerPop) %>%
  drop_na() %>% # Dropping all NAs
  rename(
    Median_Family_Income = medFamIncome,
    Families_with_two_parents = pct2Par,
    Working_moms = `pctWorkMom-6`
  ) %>% # Renaming variables
  mutate(
    Median_Income = cut(
      Median_Family_Income,
      breaks = quantile(Median_Family_Income, probs = c(0, 0.1, 0.5, 0.9, 0.99, 1), na.rm = TRUE),
      labels = c( "Very Low", "Low", "Medium", "High", "Very High"),
      include.lowest = TRUE),
    Two_Parent_Families = cut(
      Families_with_two_parents,
      breaks = quantile(Families_with_two_parents, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE),
    Working_Moms = cut(
      Working_moms,
      breaks = quantile(Working_moms, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE),
      labels = c("Low", "Medium", "High"),
      include.lowest = TRUE)
)
family_statistics_long <- family_statistics %>%
  pivot_longer(
    cols = c(Median_Income, Two_Parent_Families, Working_Moms),
    names_to = "Category",
    values_to = "Level"
  ) 
family_statistics_long <- family_statistics_long %>%
  mutate(
    Level = factor(Level, levels = c("Very Low", "Low", "Medium", "High", "Very High"))
  )
family_statistics_long <- family_statistics_long %>%
  mutate(
    Category = str_replace_all(Category, "_", " "))
```
.panelset[

.panel[.panel-name[Income]

.pull-left[
```{r  family_boxplot1, echo=FALSE, out.width="1000"}
ggplot(family_statistics_long %>% filter(Category == "Median Income"), 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  labs(
    title = "Crimes per Population vs Median Family Income",
    x = "Median Income Levels",
    y = "Number of Violent Crimes per Population"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10)
  )
```
]]

.panel[.panel-name[Parents]

.pull-left[
```{r  family_boxplot2, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long %>% filter(Category == "Two Parent Families"), 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  labs(
    title = "Crimes per Population vs Number of Two Parent Families",
    x = "Number of Two Parent Families",
    y = "Number of Violent Crimes per Population"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10)
  )
```
] ]

.panel[.panel-name[Moms]

.pull-left[
```{r  family_boxplot3, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long %>% filter(Category == "Working Moms"), 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  labs(
    title = "Crimes per Population vs Number of Working Moms",
    x = "Number of Working Moms",
    y = "Number of Violent Crimes per Population"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 9, angle = 45, hjust = 1),
    strip.text = element_text(size = 10, face = "bold"),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10)
  )
```
] ] ]

.pull-right[
- Analysis
]

---
## Familial Situation vs Violent Crimes Per 100K Box Plot
```{r  family_boxplot_full, echo=FALSE, out.width="80%", out.extra='style="display: block; margin: 0 auto;"'}
ggplot(family_statistics_long, 
       aes(x = Level, 
           y = violentPerPop, 
           fill = Level)) +
  geom_boxplot() +
  facet_wrap(~ Category, scales = "free", ncol = 3) +
  labs(
    x = "Socioeconomic Levels",
    y = "Number of violent Crimes Per Population"
  ) +
  theme_minimal() +
  theme_bw() +
  theme(
    plot.subtitle = element_text(size = 10),
    strip.text = element_text(size = 7),
    axis.text.x = element_text(size = 7, angle = 45, hjust = 1)
  )
```


---

## Scatter Plot: Familial Situation vs Violent Crimes per 100K

```{r pearsons, message=FALSE, echo=FALSE}
two_parents_correlation <- family_statistics_long %>%
  summarise(
    coef = cor(Families_with_two_parents, violentPerPop, use = "complete.obs", method = "pearson")
  )

# Correlation for Median Family Income vs Violent Crimes
median_income_correlation <- family_statistics_long %>%
  summarise(
    coef = cor(Median_Family_Income, violentPerPop, use = "complete.obs", method = "pearson")
  )

# Correlation for Working Moms vs Violent Crimes
working_moms_correlation <- family_statistics_long %>%
  summarise(
    coef = cor(Working_moms, violentPerPop, use = "complete.obs", method = "pearson")
  )
```
.panelset[

.panel[.panel-name[Parents]

.pull-left[
```{r two_parents_scatter, message=FALSE, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long, aes(
  x = Families_with_two_parents,
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "forestgreen") +
  annotate(
    "text",
    x = max(family_statistics_long$Families_with_two_parents, na.rm = TRUE),
    y = max(family_statistics_long$violentPerPop, na.rm = TRUE),
    label = paste0("r = ", round(two_parents_correlation, 3)),
    hjust = 1, size = 6
  ) +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  labs(
    title = "Crimes per Population and Number of Families with Two Parents",
    x = "Number of Families with Two Parents",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9)
  )
```
] ]

.panel[.panel-name[Income] .pull-left[
```{r income_scatter, message=FALSE, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long, aes(
  x = Median_Family_Income,
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "red") +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  annotate(
    "text",
    x = max(family_statistics_long$Median_Family_Income, na.rm = TRUE),
    y = max(family_statistics_long$violentPerPop, na.rm = TRUE),
    label = paste0("r = ", round(median_income_correlation, 3)),
    hjust = 1, size = 6
  ) +
  labs(
    title = "Crimes per Population and Median Family Income",
    x = "Median Family Income",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9)
  )
```
] ]

.panel[.panel-name[Moms] .pull-left[
```{r moms_scatter, message=FALSE, echo=FALSE, out.width="100%"}
ggplot(family_statistics_long, aes(
  x = Working_moms, 
  y = violentPerPop)) +
  geom_point(alpha = 0.5, color = "yellow") +
  geom_smooth(method = "lm", color = "black", se = FALSE) +
  annotate(
    "text",
    x = max(family_statistics_long$Working_moms, na.rm = TRUE),
    y = max(family_statistics_long$violentPerPop, na.rm = TRUE),
    label = paste0("r = ", round(working_moms_correlation, 3)),
    hjust = 1, size = 6
  ) +
  labs(
    title = "Crimes per Population and Number of Families With Working Moms",
    x = "Number of Families With Working Moms",
    y = "Violent Crimes per Population"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 9),
    axis.title.y = element_text(size = 9)
  )
```
] ] ]

.pull-right[
- Analysis
]

---
# Key Findings From Crimes and Family
- What did we find out?
- What are the implications of the results?

---

class: inverse, center, middle

# Section 3: Demographic and crimes

---

# Linear regression model

```{r, include = FALSE}
# Mutating and creating the workflow, model and recipes

data <- data %>%
  mutate(
    log_violence = log(violentPerPop)
  )

set.seed(1234)
datasplit <- initial_split(data)
data_train <- training(datasplit)
data_test  <- testing(datasplit)

data_mod <- linear_reg() %>%
  set_engine("lm")

data_rec <- recipe(log_violence ~ pctPoverty + pct2Par, data = data_train)
data_rec2 <- recipe(violentPerPop ~ pctPoverty + pct2Par, data = data_train)

data_wflow <- workflow() %>%
  add_model(data_mod) %>%
  add_recipe(data_rec)

data_wflow2 <- workflow() %>%
  add_model(data_mod) %>%
  add_recipe(data_rec2)

# Fitting the model with training data

data_fit <- data_wflow %>%
  fit(data = data_train)

data_fit2 <- data_wflow2 %>%
  fit(data = data_train)

# Predicting the training data

data_train_pred <- data_fit %>%
  predict(data_train) %>%
  bind_cols(data_train %>% select(log_violence,communityname))

data_train_pred2 <- data_fit2 %>%
  predict(data_train) %>%
  bind_cols(data_train %>% select(violentPerPop,communityname))

rsq(data_train_pred, truth = log_violence, estimate = .pred)

data_train_augmented <- augment(data_fit, new_data = data_train)
data_train_augmented2 <- augment(data_fit2, new_data = data_train)

# Predicting the testing data

data_test_pred <- data_fit %>%
  predict(data_test) %>%
  bind_cols(data_test %>% select(log_violence,communityname))

rsq(data_test_pred, truth = log_violence, estimate = .pred)

data_test_augmented <- augment(data_fit, new_data = data_test)

```

- In order to make the best model we decided to use the explanatory variables: `pctPoverty` and `pct2Par`.

- Nevertheless, the assumption of a linear correlation between the predictor variables and the outcome variable (`violentPerPop`) didn't seem to hold.

--

<div style="text-align: center; padding: 20px; background-color: #2ecc71; color: #fff; font-size: 1.5em; border-radius: 10px;">

💡 Therefore, we applied a logarithmic transformation!

</div>

```r
data <- data %>%
  mutate(
    log_violence = log(violentPerPop)
  )
```

---

# Comparison of residuals plot, before and after the logarithmic transformation

.pull-left[

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width=6}

ggplot(data_train_augmented2, aes(x = .pred, y = .resid)) +
  geom_point(color = "darkgreen", size = 1.5, alpha = 0.8, shape = 21, fill = "lightblue") +
  labs(
    title = "Residuals Plot",
    subtitle = "Predicted training data vs residuals",
    x = "Predicted violence per 100K",
    y = "Residuals"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(face = "bold", size = 15),
    plot.subtitle = element_text(face = "italic", color = "darkgray"),
    panel.background = element_rect(fill = "#f5f5f5", color = NA),                      
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),               
    panel.grid.minor = element_blank()                                                  
  )

```

]
.pull-right[

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width=6}

ggplot(data_train_augmented, aes(x = .pred, y = .resid)) +
  geom_point(color = "darkgreen", size = 1.5, alpha = 0.8, shape = 21, fill = "lightblue") +
  labs(
    title = "Residuals Plot",
    subtitle = "Predicted training data vs residuals",
    x = "Predicted log_violence",
    y = "Residuals"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(face = "bold", size = 15),
    plot.subtitle = element_text(face = "italic", color = "darkgray"),
    panel.background = element_rect(fill = "#f5f5f5", color = NA),                      
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),               
    panel.grid.minor = element_blank()                                                  
  )


```

]

---

# Predicting the testing data

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 8}

ggplot(data_test_augmented, aes(x = .pred, y = .resid)) +
  geom_point(color = "darkgreen", size = 1.5, alpha = 0.8, shape = 21, fill = "lightblue") +
  labs(
    title = "Residuals Plot",
    subtitle = "Predicted training data vs residuals",
    x = "Predicted log_violence",
    y = "Residuals"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(face = "bold", size = 15),
    plot.subtitle = element_text(face = "italic", color = "darkgray"),
    panel.background = element_rect(fill = "#f5f5f5", color = NA),                      
    panel.grid.major = element_line(color = "gray", linetype = "dashed"),               
    panel.grid.minor = element_blank()                                                  
  )

```

---

# Results

---

# Results in Context

---

# Discussion

---

# Conclusion

